## Contents:
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Upload images to IBM Cloud Container Registry](#upload-images-to-ibm-cloud-container-registry)
4. [Provide registry READ permission and create API Key](#provide-registry-read-permission-and-create-api-key)
5. [Review the Vulnerability Advisor report for the images](#review-the-vulnerability-advisor-report-for-the-images)
6. [Update the Operator and bundle artifacts](#update-the-operator-and-bundle-artifacts-as-per-best-practices-guidelines)
7. [Push the Operator bundle to a GIT repository](#push-the-operator-bundle-to-a-git-repository)
8. [Onboard the Operator to IBM Cloud](#onboard-the-operator-to-ibm-cloud)
9. [Upgrade to a new Operator version](#upgrade-to-a-new-version)


****
## Overview

This repository contains a sample Node-Red Red Hat certified Operator that helps you understand how to prepare your Operator and bundle directory structure for onboarding to IBM Cloud. 

**NOTE**: This example illustrates the Node-Red operator upgrade scenario where we are upgrading Node-Red operator from its base version v1.0.0 to v2.0.0.  

## Prerequisites

 Make sure that you complete the following prerequisites before you begin:

1. Verify that you're using a Pay-As-You-Go or Subscription account. See [Viewing your account type](https://cloud.ibm.com/docs/account?topic=account-account_settings#view-acct-type) for more details.
2. Use the [latest supported Operator-SDK version](https://docs.openshift.com/container-platform/4.5/operators/operator_sdk/osdk-getting-started.html) to create your Operator. 

## Upload images to IBM Cloud Container Registry

A certified Operator includes the following images:

* Operator image
* Application container images
* Operator bundle image

To onboard your Operator to IBM Cloud, you upload your application images and Operator image to IBM Cloud Container Registry.

**Note**: It is required that the Operator image is uploaded to a Container Registry namespace for which a read API key can be created and shared during the Operator onboarding process. This requirement is only for the Operator image.

For more information, see [Getting started with IBM Cloud Container Registry](https://cloud.ibm.com/docs/Registry?topic=Registry-getting-started).

## Assign permissions and create an API Key

Create an IAM service ID with read access to the Container Registry service for a namespace that contains the Operator image, and create an API key for the same. For more information, see [Manager access for Container Registry](https://cloud.ibm.com/docs/Registry?topic=Registry-iam).  

## Review the Vulnerability Advisor report for the images

The images used by your Operator must be free from all vulnerabilities and security issues. When you upload your images, the vulnerability scans run automatically. You can view the scan results of the uploaded Images on the IBM Cloud Registry. For more information, see [Managing image security with Vulnerability Advisor](https://cloud.ibm.com/docs/Registry?topic=va-va_index#app_configurations).

## Update the Operator and bundle artifacts

Before you begin with the best practices, make sure that you have generated your operator bundle using [*latest supported*](https://docs.openshift.com/container-platform/4.5/operators/operator_sdk/osdk-getting-started.html) operator sdk.

The folder structure of your operator bundle should look like the example given below for node-red-operator.

```
.
├── bundle
|   ├── manifests
|   |   ├── nodered.com_noderedbackups.yaml
|   │   ├── nodered.com_noderedrestores.yaml
|   │   │── nodered.com_nodereds.yaml
|   │   └── node-red-operator.clusterserviceversion.yaml
|   ├── metadata
|	    └── annotations.yaml
├── bundle.Dockerfile
```

Also , validate your operator bundle by executing the following command on the root directory of your project:

```execute
operator-sdk bundle validate ./bundle
```

After you validate your operator bundle, you're ready to start the Operator Bundle Artifact Check process.

**a) Check CRD version**

By default the operator-sdk creates the latest version of CustomResourceDefinition(CRD) `v1`. The older versions of OpenShift (4.5 and earlier) only support `v1beta1`. For backward support its recommended to change the version of CRD to `v1beta1`. 

See the [example CRD](https://github.com/IBM-Cloud/isv-operator-product-deploy-sample/blob/main/bundle/2.0.0/manifests/nodered.com_nodereds_crd.yaml) from Node Red Operator.

**b) Check CSV fields**

There are a few important fields in your bundle CSV file that don't get generated by default. So, it is recommended that you make the required changes to your CSV file manually.

You need to add personalized data to the following required fields of the CSV.

| field                              | sub-field                                                    | Description                                                  |
| ---------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| metadata                           | name                                                         | The name of your CSV file. In general, the naming convention includes the name of the operator followed by the semantic version number, separated by a period (for example, node-red-operator.v2.1.0). |
| metadata                           | namespace                                                    | The namespace in which the Operator is installed. It should be set as ```placeholder``` |
| annotations                        | alm-examples                                                 | An array containing the CRD templates. The users of your Operator should be aware of mandatory and optional choices. You can upload the CRD templates containing a minimum set of configuration as an annotation in JSON format. |
| annotations                        | capabilities:                                                | Based on the operator maturity model, the capability can be classified as Basic Install or Seamless Upgrades or Full Lifecycle or Deep Insights or Auto Pilot |
| annotations                        | categories                                                   | A category is a comma separated string of applicable category names. |
| annotations                        | description                                                  | A short description of the Operator.                 |
| annotations                        | createdAt                                                    | A rough estimate (to the day) describing when the Operator image was created. |
| annotations                        | support                                                      | Contains the  name of the supporting vendor (for example, ExampleCo). |
| annotations                        | certified                                                    | (deprecated) This string has no effect, but can be set to "true" or "false" |
| annotations                        | repository                                                   | An optional URL of the Operator's source code repository. If you don't want to specify , set it to NA. |
| spec                               | version                                                      | The value you enter in this field indicates the current version of the operator. |
| spec                               | replaces                                                     | This interprets as “the previous version to be replaced with a particular version". This field is very important for version upgrades to take place. |
| spec                               | customresourcedefinitions.owned                              | List all the CRDs for your operator in this section.         |
| spec                               | icon                                                         | This is typically a ```base64data``` encoded icon                              |
| spec                               | install                                                      | Contains details of Operator Deployment definition which is used to deploy the operator pod. |
| spec.install.spec.containers[].env | RELATED_IMAGE_ Environment variable in container definition of Operator Deployment | Ensure your Operator is updated to support Air-Gap feature. [*Learn more*](https://redhat-connect.gitbook.io/certified-operator-guide/appendix/offline-enabled-operators) |
| spec                               | serviceAccountName                                           | The name of the service account to which the RBAC is assigned. Operator gets the required permissions for its deployments and execution from this serviceaccount. |
| spec                               | clusterPermissions                                           | Define all the required cluster permissions for your operator's serviceAccount |
| spec                               | Permissions                                                  | Define all the required namespace level permissions for your operator's serviceAccount |
| spec                               | description                                                  | A require field that shows the details about the Operator Description, its feature , how to use it, pre-requisites etc.  |
| spec                               | maintainers                                                  | A comma-separated list of maintainers and their emails (e.g. 'name1:email1, name2:email2') |
| spec                               | keywords                                                     | A comma-separated list of keywords for your Operator |
| spec                               | provider                                                     | The provider's name for the Operator                   |



**NOTE**: Ensure that the CSV references the application images and Operator image from IBM Cloud Registry.

Check the CSV for [*node-red-operator*](https://github.com/IBM-Cloud/isv-operator-product-deploy-sample/blob/main/bundle/2.0.0/manifests/node-red-operator.v2.0.0.clusterserviceversion.yaml) for more details.


**c) Check bundle.Dockerfile**

The `bundle.Dockerfile` in the root directory of your operator project is the Dockerfile for your metadata bundle image. 

Make sure the following 3 labels are present in the Dockerfile:

* `LABEL com.redhat.openshift.versions="v4.5,v4.6"` : This lists the OpenShift versions, starting with 4.5, that your operator will support. The value should with the letter 'v', followed by the number with no space in between.
* `LABEL com.redhat.delivery.operator.bundle=true` : This just needs to be there
* `LABEL com.redhat.deliver.backport=true` : This indicates the support provision for OpenShift versions before 4.5. If you don't specify this flag, your operator won't be listed in 4.4 or earlier.

As a best practice you may want to add the default channel and package name by adding the following labels for smooth onboarding to IBM cloud.

`LABEL operators.operatorframework.io.bundle.channel.default.v1=alpha`

`LABEL operators.operatorframework.io.bundle.package.v1=node-red-operator-certified`

For more details, refer the example   [*node-red-operator*](https://github.com/IBM-Cloud/isv-operator-product-deploy-sample/blob/main/bundle/bundle-2.0.0.Dockerfile) 

**d) Check annotations.yaml**

For a smooth onboarding you need to have all the labels present in your `bundle.Dockerfile` contained in your `annotations.yaml`.

Make sure you add the package name properly.

`operators.operatorframework.io.bundle.package.v1: node-red-operator-certified`

See [*node-red-operator*](https://github.com/IBM-Cloud/isv-operator-product-deploy-sample/blob/main/bundle/2.0.0/metadata/annotations.yaml) example for more details.


## Push the operator bundle to a GIT repository

If you have updated your Operator Bundle Artifacts as per the above instructions , make sure you validate your bundle once again using the following command. 

```execute
operator-sdk bundle validate ./bundle
```

If it produces any error or warning please ensure that you resolve all of them.

Upload to Git repository your operator bundle artifacts in one of the below required formats based on the release type.

* First Operator Bundle version Release (example 1.0.0):

```
.
├── bundle
|   ├── manifests
|   |   ├── nodered.com_noderedbackups.yaml
|   │   ├── nodered.com_noderedrestores.yaml
|   │   │── nodered.com_nodereds.yaml
|   │   └── node-red-operator.clusterserviceversion.yaml
|   ├── metadata
|	    └── annotations.yaml
├── bundle.Dockerfile
```

* Subsequent Operator Bundle version upgrades (example 2.0.0):

```
bundle
├── 1.0.0
│   ├── manifests
│   │   ├── nodered.com_noderedbackups_crd.yaml
│   │   ├── nodered.com_noderedrestores_crd.yaml
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v1.0.0.clusterserviceversion.yaml
│   └── metadata
│       └── annotations.yaml
├── 2.0.0
│   ├── manifests
│   │   ├── nodered.com_noderedbackups_crd.yaml
│   │   ├── nodered.com_noderedrestores_crd.yaml
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v2.0.0.clusterserviceversion.yaml
│   └── metadata
│       └── annotations.yaml
├── bundle-1.0.0.Dockerfile
└── bundle-2.0.0.Dockerfile

```

**NOTE:** While onboarding your operator to IBM Cloud Catalog , you would need to provide the URL of the ClusterServiceVersion(CSV) file residing in the git repository.

_Example CSV URL for Node Red Operator Release Version 2.0.0 would be_: https://github.com/IBM-Cloud/isv-operator-product-deploy-sample/blob/main/bundle/2.0.0/manifests/node-red-operator.v2.0.0.clusterserviceversion.yaml 


## Onboard the Operator to IBM Cloud

The onboarding process includes importing your CSV file that you created in the previous section to a private catalog, configuring the deployment variables, and  validating that the Operator can be installed on a target cluster. See [Onboarding an Operator](https://cloud.ibm.com/docs/third-party?topic=third-party-operator-onboard) for more information. 

## Upgrade to a new version

A new version of an operator can be released in any of the following scenarios:
a) Update the Product version used in the operator

b) Update in Operator code 

If you need to release a new version of the operator (say 2.0.0), while your present version is 1.0.0), follow the below procedure:

**a) Copy the bundle and modify the version**

Copy the folder contents of the previous version(example:1.0.0) to a new folder called 2.0.0, which will be the new release version.

```
├── 1.0.0
│   ├── manifests
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v1.0.0.clusterserviceversion.yaml
│   ├── metadata
│       └── annotations.yaml   
├── bundle-1.0.0.Dockerfile
```

 Change the version number in the CSV file name. See the sample below

```
├── 2.0.0
│   ├── manifests
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v2.0.0.clusterserviceversion.yaml
│   ├── metadata
│       └── annotations.yaml   
├── bundle-2.0.0.Dockerfile
```

Now you should have two folders representing two versions as shown below

```
├── 1.0.0
│   ├── manifests
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v1.0.0.clusterserviceversion.yaml
│   ├── metadata
│       └── annotations.yaml  
├── 2.0.0
│   ├── manifests
│   │   ├── nodered.com_nodereds_crd.yaml
│   │   └── node-red-operator.v2.0.0.clusterserviceversion.yaml
│   ├── metadata
│       └── annotations.yaml  
├── bundle-1.0.0.Dockerfile
├── bundle-2.0.0.Dockerfile
```

**b) Make changes in the CSV file**

It is the most important step for any version upgrade.

To ensure that the upgraded contents are there inside  `clusterserviceversion.yaml`, the following modifications are required for the CSV file inside the newly created folder, 2.0.0.

  1) Update the `metadata.name` field of the CSV file with the new version(2.0.0). 

     ```
     name: node-red-operator.v2.0.0
     ```

  2) Update the `spec.version` field with the new version. 

     ```
     version: 2.0.0
     ```

  3) Update the `spec.replaces` field to indicate the previous version(1.0.0) of the CSV that is being upgraded to the new version(2.0.0). 

     ```
     replaces: node-red-operator.v1.0.0
     ```

  **NOTE:** Along with the above metadata updates to the CSV file, you will also need to update the new version of Operator Image and/or Application Image(s) based on the updates associated with the new release.



**c) Validate the Operator bundle**

After you update your Operator bundle, validate your bundle by using the following command. 

```execute
operator-sdk bundle validate ./2.0.0
```
Be sure to resolve any error or warning that's reported.

****



****

